{% extends 'base.html' %}
{% block content %}
<div class="animate-fade-in">
  <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-10 mb-8 rounded-2xl">
    <h1 class="text-3xl font-bold"><i class="fas fa-layer-group mr-2"></i>Manage Sections</h1>
    <p class="text-indigo-100">View, filter, and manage course sections</p>
  </div>

  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <a href="{{ url_for('admin.create_section') }}" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
      <i class="fas fa-plus mr-2"></i>New Section
    </a>
    <form method="get" class="flex flex-wrap items-center gap-3">
      <label class="text-sm">Course</label>
      <select name="course_id" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <option value="">All</option>
        {% for c in courses %}
          <option value="{{ c.id }}" {% if selected_course_id and selected_course_id == c.id %}selected{% endif %}>{{ c.code }} - {{ c.title }}</option>
        {% endfor %}
      </select>
      <label class="text-sm">Term</label>
      <div class="flex items-center gap-2">
        <input id="term-filter" type="text" name="term" value="{{ term or '' }}" placeholder="e.g. Spring 2025" list="term-options" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <button type="button" class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded clear-input" data-target="term-filter" title="Clear">
          <i class="fas fa-times text-gray-500"></i>
        </button>
      </div>
      {% if term_options %}
      <datalist id="term-options">
        {% for t in term_options %}
          <option value="{{ t }}"></option>
        {% endfor %}
      </datalist>
      {% endif %}
      {% import 'macros/term_picker.html' as term_macros with context %}
      <div class="flex items-center gap-2">{{ term_macros.widget('term-filter') }}</div>
      <label class="text-sm">Status</label>
      <select name="status" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <option value="">All</option>
        {% for s in ['Open','Closed','Cancelled'] %}
          <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
      <label class="text-sm">Instructor</label>
      <div class="flex items-center gap-2">
        <input type="text" id="instructor-filter" placeholder="Filter" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <button type="button" class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded clear-input" data-target="instructor-filter" title="Clear">
          <i class="fas fa-times text-gray-500"></i>
        </button>
      </div>
      <select id="instructor-select" name="instructor_id" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <option value="">All</option>
        {% if instructors %}
          {% for i in instructors %}
            <option value="{{ i.id }}" {% if instructor_id and instructor_id == i.id %}selected{% endif %}>{{ i.user.full_name }}</option>
          {% endfor %}
        {% endif %}
      </select>
      <label class="text-sm">Mode</label>
      <select name="delivery_mode" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <option value="">All</option>
        {% for m in ['In-Person','Online','Hybrid'] %}
          <option value="{{ m }}" {% if delivery_mode == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
      {% include 'partials/per_page_select.html' %}
      <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Apply</button>
      <a href="{{ url_for('admin.sections') }}" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg">Clear</a>
    </form>
  </div>

  {% if sections %}
  <form id="bulkForm" method="post" action="{{ url_for('admin.sections_bulk') }}" class="mb-3">
    {% if bulk_form is defined %}{{ bulk_form.hidden_tag() }}{% elif delete_form is defined %}{{ delete_form.hidden_tag() }}{% endif %}
    <div class="flex items-center gap-3">
      <select name="action" id="bulk-action" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <option value="open">Open</option>
        <option value="close">Close</option>
        <option value="cancel">Cancel</option>
        <option value="assign_instructor">Assign Instructor</option>
      </select>
      <div id="instructor-input" class="hidden">
        {% if instructors %}
        <div class="flex items-center gap-2">
          <input type="text" id="bulk-instructor-filter" placeholder="Filter instructors" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          <button type="button" class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded clear-input" data-target="bulk-instructor-filter" title="Clear">
            <i class="fas fa-times text-gray-500"></i>
          </button>
        </div>
        <select id="bulk-instructor-select" name="instructor_id" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          <option value="">Select instructor</option>
          {% for i in instructors %}
            <option value="{{ i.id }}">{{ i.user.full_name }}</option>
          {% endfor %}
        </select>
        {% else %}
        <input type="number" name="instructor_id" placeholder="Instructor ID" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" />
        {% endif %}
      </div>
      <button type="button" id="bulk-submit" class="js-confirm px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50" disabled>Apply</button>
    </div>
  </form>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50 dark:bg-gray-900">
        <tr>
          <th class="px-6 py-3 text-left">
            <input type="checkbox" id="select-all" class="rounded">
          </th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Course</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Section</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Term</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Instructor</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Capacity</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Dates</th>
          <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
        {% for s in sections %}
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
<td class="px-6 py-4"><input type="checkbox" name="selected_ids" value="{{ s.id }}" class="row-checkbox" form="bulkForm"></td>
          <td class="px-6 py-4 text-gray-900 dark:text-white font-medium">{{ s.course.code }} - {{ s.course.title }}</td>
          <td class="px-6 py-4 text-gray-900 dark:text-white">{{ s.section_code }}</td>
          <td class="px-6 py-4 text-gray-900 dark:text-white">{{ s.term }}</td>
          <td class="px-6 py-4 text-gray-900 dark:text-white">{{ s.instructor.user.full_name if s.instructor else 'Unassigned' }}</td>
          <td class="px-6 py-4 text-gray-900 dark:text-white">{{ s.enrolled_count }}/{{ s.capacity }}</td>
          <td class="px-6 py-4 text-gray-900 dark:text-white">{{ s.start_date.strftime('%Y-%m-%d') if s.start_date }} - {{ s.end_date.strftime('%Y-%m-%d') if s.end_date }}</td>
          <td class="px-6 py-4 text-right">
            <a href="{{ url_for('admin.edit_section', section_id=s.id) }}" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition">Edit</a>
            <form method="post" id="delete-section-{{ s.id }}" action="{{ url_for('admin.delete_section', section_id=s.id) }}" class="inline">
              {{ delete_form.hidden_tag() }}
              <button type="button" data-form-id="delete-section-{{ s.id }}" data-message="Delete this section?" class="js-confirm px-3 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

    {% if pagination and pagination.pages > 1 %}
  <div class="flex justify-center space-x-2 mt-6">
    {% set qs = request.query_string.decode('utf-8') %}
    {% if pagination.has_prev %}
      <a href="{{ url_for('admin.sections', page=pagination.prev_num, per_page=pagination.per_page, course_id=selected_course_id or '', term=term or '', status=status or '', instructor_id=instructor_id or '', delivery_mode=delivery_mode or '') }}" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
        <i class="fas fa-chevron-left"></i>
      </a>
    {% endif %}
    {% for p in pagination.iter_pages() %}
      {% if p %}
        {% if p == pagination.page %}
          <span class="px-3 py-2 bg-indigo-600 text-white rounded-lg">{{ p }}</span>
        {% else %}
          <a href="{{ url_for('admin.sections', page=p, per_page=pagination.per_page, course_id=selected_course_id or '', term=term or '', status=status or '', instructor_id=instructor_id or '', delivery_mode=delivery_mode or '') }}" class="px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">{{ p }}</a>
        {% endif %}
      {% else %}
        <span class="px-2 py-2 text-gray-500">...</span>
      {% endif %}
    {% endfor %}
    {% if pagination.has_next %}
      <a href="{{ url_for('admin.sections', page=pagination.next_num, per_page=pagination.per_page, course_id=selected_course_id or '', term=term or '', status=status or '', instructor_id=instructor_id or '', delivery_mode=delivery_mode or '') }}" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
        <i class="fas fa-chevron-right"></i>
      </a>
    {% endif %}
  </div>
  {% endif %}

  {% else %}
  <div class="text-center py-16 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
    <div class="w-24 h-24 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-layer-group text-5xl text-gray-400"></i>
    </div>
    <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-2">No Sections</h3>
    <p class="text-gray-600 dark:text-gray-400">Create a new section to get started</p>
  </div>
  {% endif %}

  <script>
    (function() {
      const actionSelect = document.getElementById('bulk-action');
      const instructorInput = document.getElementById('instructor-input');
      const selectAll = document.getElementById('select-all');
      const checkboxes = document.querySelectorAll('.row-checkbox');
      const submitBtn = document.getElementById('bulk-submit');

      // Filters
      const filterInput = document.getElementById('instructor-filter');
      const instructorSelect = document.getElementById('instructor-select');
      const bulkFilterInput = document.getElementById('bulk-instructor-filter');
      const bulkInstructorSelect = document.getElementById('bulk-instructor-select');
      const termFilterInput = document.getElementById('term-filter');

      function filterOptions(input, select) {
        if (!input || !select) return;
        const q = input.value.trim().toLowerCase();
        Array.from(select.options).forEach(opt => {
          if (!opt.value) return; // keep 'All' or placeholder always visible
          const show = opt.text.toLowerCase().includes(q);
          opt.hidden = !show;
        });
      }
      if (filterInput && instructorSelect) {
        filterInput.addEventListener('input', () => filterOptions(filterInput, instructorSelect));
      }
      if (bulkFilterInput && bulkInstructorSelect) {
        bulkFilterInput.addEventListener('input', () => filterOptions(bulkFilterInput, bulkInstructorSelect));
      }
      if (termFilterInput) {
        document.querySelector('[data-target="term-filter"]')?.addEventListener('click', () => { termFilterInput.value=''; termFilterInput.dispatchEvent(new Event('input')); });
      }
      document.querySelectorAll('.clear-input').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.getAttribute('data-target'));
          if (target){ target.value=''; target.dispatchEvent(new Event('input')); }
        });
      });

      function updateState() {
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        submitBtn.disabled = !anyChecked;
        if (actionSelect && actionSelect.value === 'assign_instructor') {
          instructorInput.classList.remove('hidden');
        } else {
          instructorInput.classList.add('hidden');
        }
      }

      if (selectAll) {
        selectAll.addEventListener('change', () => {
          checkboxes.forEach(cb => cb.checked = selectAll.checked);
          updateState();
        });
      }
      checkboxes.forEach(cb => cb.addEventListener('change', updateState));
      if (actionSelect) actionSelect.addEventListener('change', updateState);
      updateState();

    })();
  </script>
</div>
{% endblock %}
